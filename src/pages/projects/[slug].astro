---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const projects = await getCollection('projects');
	return projects.map((p) => ({ params: { slug: p.slug } }));
}

const base = import.meta.env.BASE_URL.endsWith('/')
	? import.meta.env.BASE_URL
	: import.meta.env.BASE_URL + '/';

const withBase = (path: any) => `${base}${String(path).replace(/^\/+/, '')}`;

const projects = await getCollection('projects');
const project = projects.find((p) => p.slug === Astro.params.slug);

if (!project) throw new Error(`Project not found: ${Astro.params.slug}`);

const { Content } = await project.render();
---

<BaseLayout title={`${project.data.title} | Aaron Cannon`}>
	<section class="border-b border-zinc-800/60">
		<div class="mx-auto max-w-6xl px-4 py-12">
			<a
				class="text-sm text-zinc-300 hover:text-white hover:underline"
				href={`${base}#projects`}
			>
				‚Üê Back to Projects
			</a>

			<h1 class="mt-6 text-3xl font-semibold tracking-tight">
				{project.data.title}
			</h1>

			<div class="mt-4 flex flex-wrap gap-2 text-sm text-zinc-300">
				<span class="rounded-md border border-zinc-700 bg-zinc-900/30 px-2 py-1"
					>{project.data.year}</span
				>
				<span class="rounded-md border border-zinc-700 bg-zinc-900/30 px-2 py-1"
					>{project.data.engine}</span
				>
				<span class="rounded-md border border-zinc-700 bg-zinc-900/30 px-2 py-1"
					>{project.data.team}</span
				>
				<span class="rounded-md border border-zinc-700 bg-zinc-900/30 px-2 py-1"
					>{project.data.type}</span
				>
				<span class="rounded-md border border-zinc-700 bg-zinc-900/30 px-2 py-1"
					>{project.data.role}</span
				>
			</div>

			<div class="mt-8 grid gap-8 lg:grid-cols-3">
				<div class="lg:col-span-2 prose prose-invert max-w-none">
					<Content />

					{
						project.data.gallery?.length ? (
							<div class="not-prose mt-10">
								<h2 class="text-xl font-semibold tracking-tight text-zinc-100">
									Gallery
								</h2>
								<div class="mt-4 grid gap-4 sm:grid-cols-2">
									{project.data.gallery.map((img) => (
										<figure class="overflow-hidden rounded-xl border border-zinc-800 bg-zinc-900/20">
											<a
												href={withBase(img.src)}
												target="_blank"
												rel="noreferrer"
											>
												<img
													src={withBase(img.src)}
													alt={img.alt}
													class="aspect-16/10 w-full object-cover transition-transform duration-300 hover:scale-[1.02]"
													loading="lazy"
												/>
											</a>
											{(img.caption || img.alt) && (
												<figcaption class="border-t border-zinc-800 px-4 py-3 text-sm text-zinc-300">
													{img.caption ?? img.alt}
												</figcaption>
											)}
										</figure>
									))}
								</div>
							</div>
						) : null
					}
				</div>

				<aside class="lg:col-span-1">
					<div
						class="overflow-hidden rounded-xl border border-zinc-800 bg-zinc-900/20"
					>
						<div class="aspect-16/10 border-b border-zinc-800">
							<img
								src={withBase(project.data.coverImage)}
								alt={`Screenshot from ${project.data.title}`}
								class="h-full w-full object-cover"
							/>
						</div>
						<div class="p-5 text-sm text-zinc-300">
							<p class="font-medium text-zinc-100">Summary</p>
							<p class="mt-2">{project.data.summary}</p>
						</div>
					</div>
				</aside>
			</div>
		</div>
	</section>
</BaseLayout>
